<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>روايات سيف | عالم من الخيال والإبداع</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Light Theme (Default) */
      --primary: #5c6bc0; /* Main interactive color */
      --primary-dark: #3f51b5; /* Darker shade of primary */
      --secondary: #ff7043; /* Accent color */
      --light-bg: #f5f7fa; /* Overall page background */
      --light-bg-alt: #e4e7f1; /* Slightly different background for depth */
      --card-bg: #ffffff; /* Card backgrounds */
      --text: #2d3748; /* Main text color */
      --text-on-primary: #ffffff; /* Text color on primary backgrounds */
      --text-light: #718096; /* Lighter text for secondary info */
      --text-darker: #1a237e; /* Darker text, often for titles on light bg */
      --border: #e2e8f0; /* Border color */
      --shadow: rgba(0, 0, 0, 0.08); /* Shadow color */
      --header-grad-start: #5c6bc0;
      --header-grad-end: #8e24aa;
      --page-header-grad-start: var(--primary);
      --page-header-grad-end: var(--primary-dark);
      --body-bg-gradient: linear-gradient(135deg, var(--light-bg) 0%, var(--light-bg-alt) 100%);
      --input-bg: #f9fafb; /* Input field background */
      --placeholder-bg: #e0e7ff; /* For image placeholders */
      --category-bg: #f0f4ff; /* Category tag background */
      --category-border: #dbe4ff; /* Category tag border */
      --category-text: var(--primary); /* Category tag text color */
      --ads-bg: #f0f2f5; /* Ads placeholder background */
      --success: #4CAF50; /* Success color for notifications */
      --error: #F44336; /* Error color for notifications */
    }

    body.dark-mode {
      /* Dark Theme */
      --primary: #7986cb; /* Lighter primary for dark mode */
      --primary-dark: #5c6bc0; /* Original primary, acts as darker in dark mode */
      --secondary: #ff8a65; /* Lighter accent */
      --light-bg: #1f202c; /* Darker overall background */
      --light-bg-alt: #181924; /* Alternative dark background */
      --card-bg: #2a2c3a;   /* Dark card background */
      --text: #e0e0e0; /* Light text for dark mode */
      --text-on-primary: #ffffff; /* Text on primary buttons (can be light gray if primary is very light) */
      --text-light: #a0a0b0; /* Lighter secondary text */
      --text-darker: #c5cae9; /* Lighter, more prominent text for titles */
      --border: #3b3e52;   /* Darker border */
      --shadow: rgba(0, 0, 0, 0.15); /* Shadow might be slightly more visible */
      --header-grad-start: #393b52;
      --header-grad-end: #4a4e6e;
      --page-header-grad-start: var(--primary-dark);
      --page-header-grad-end: var(--primary);
      --input-bg: #303245; /* Dark input background */
      --placeholder-bg: #303245; /* Dark placeholder background */
      --category-bg: #303245; /* Dark category background */
      --category-border: #3b3e52; /* Dark category border */
      --category-text: var(--primary); /* Primary still works as text color */
      --ads-bg: #252734; /* Dark ads placeholder background */
      --success: #66bb6a;
      --error: #ef5350;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Cairo", sans-serif;
      background: var(--body-bg-gradient);
      color: var(--text);
      line-height: 1.8;
      min-height: 100vh;
      background-attachment: fixed;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .app-container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }

    header { background: linear-gradient(90deg, var(--header-grad-start), var(--header-grad-end)); padding: 0.2rem 0; box-shadow: 0 2px 8px var(--shadow); position: sticky; top: 0; z-index: 100; transition: background 0.3s ease;}
    .header-content { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
    .logo { display: flex; align-items: center; gap: 6px; }
    .logo i { font-size: 1.5rem; color: white; background: rgba(255, 255, 255, 0.15); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .logo h1 { color: white; font-size: 1.2rem; font-weight: 600; letter-spacing: -0.25px; }

    .header-right-items { display: flex; align-items: center; gap: 10px; }
    .theme-toggle-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: background 0.3s ease, transform 0.2s ease; }
    .theme-toggle-btn:hover { background: rgba(255,255,255,0.25); transform: scale(1.05); }
    body.dark-mode .theme-toggle-btn { background: rgba(200,200,250,0.1); border-color: rgba(200,200,250,0.2); }

    nav { display: flex; gap: 8px; }
    nav a { color: rgba(255, 255, 255, 0.85); font-size: 0.8rem; text-decoration: none; padding: 4px 8px; border-radius: 20px; transition: all 0.3s ease; display: flex; align-items: center; gap: 4px; font-weight: 500; }
    nav a:hover, nav a.active { background: rgba(255, 255, 255, 0.2); transform: translateY(-1px); color: #fff; }
    nav a i { font-size: 0.8rem; }

    .container { margin: 20px auto; padding: 0; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px var(--shadow); background: var(--card-bg); transition: background-color 0.3s ease, box-shadow 0.3s ease;}
    .page-header { background: linear-gradient(90deg, var(--page-header-grad-start), var(--page-header-grad-end)); padding: 20px 25px; color: white; display: flex; align-items: center; gap: 15px; transition: background 0.3s ease;}
    .page-header h2 { font-size: 1.6rem; font-weight: 700; margin: 0; flex-grow: 1; text-align: left; }
    .page-header > i { font-size: 1.6rem; background: rgba(255, 255, 255, 0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .page-content { padding: 25px; }

    .search-container { margin-bottom: 25px; position: relative; }
    #search-bar { width: 100%; padding: 12px 40px 12px 20px; font-size: 1.1rem; border: 1px solid var(--border); border-radius: 10px; font-family: "Cairo", sans-serif; background-color: var(--input-bg); color: var(--text); transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;}
    #search-bar:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); }
    .search-container .search-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-light); }

    .categories { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 25px; }
    .category { padding: 7px 18px; background-color: var(--category-bg) ; border-radius: 20px; color: var(--category-text); font-weight: 500; cursor: pointer; transition: all 0.3s; border: 1px solid var(--category-border); font-size: 0.9rem; }
    .category:hover { background-color: color-mix(in srgb, var(--primary) 20%, transparent); border-color: var(--primary); color: var(--primary);}
    .category.active { background-color: var(--primary); color: var(--text-on-primary); border-color: var(--primary-dark); }
    body.dark-mode .category.active { color: var(--text-on-primary); /* Ensure good contrast on dark primary */ }

    .stories-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 20px; margin-top: 20px; }
    .story-card-visual { background-color: var(--card-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px var(--shadow); transition: all 0.3s ease-in-out; cursor: pointer; border: 1px solid var(--border); display: flex; flex-direction: column; position: relative; }
    .story-card-visual:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 20px color-mix(in srgb, var(--shadow) 150%, transparent); }
    .story-image-visual { width: 100%; height: 200px; object-fit: cover; display: block; background-color: var(--placeholder-bg); }
    .story-card-visual .no-image-placeholder { width: 100%; height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: var(--placeholder-bg); color: var(--primary); text-align: center; }
    .story-card-visual .no-image-placeholder i { font-size: 2.2rem; margin-bottom: 8px; }
    .story-card-visual .no-image-placeholder span { font-size: 0.85rem; }
    .story-title-visual { padding: 10px 12px; font-size: 1rem; font-weight: 600; color: var(--text-darker); text-align: center; border-top: 1px solid var(--border); background-color: color-mix(in srgb, var(--card-bg) 95%, var(--border) 5%); flex-grow: 1; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;}

    .btn-delete-story {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 5;
        background-color: rgba(244, 67, 54, 0.8);
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .btn-delete-story:hover {
        background-color: var(--error);
        transform: scale(1.1);
    }
    body.dark-mode .btn-delete-story {
       background-color: rgba(239, 83, 80, 0.8);
    }
    body.dark-mode .btn-delete-story:hover {
       background-color: var(--error);
    }

    .no-stories { text-align: center; padding: 40px 20px; background: color-mix(in srgb, var(--card-bg) 50%, transparent); border-radius: 10px; border: 2px dashed var(--border); margin: 20px 0; grid-column: 1 / -1; }
    .no-stories i { font-size: 3rem; color: var(--primary); margin-bottom: 12px; opacity: 0.4; }
    .no-stories h3 { font-size: 1.4rem; color: var(--text-darker); margin-bottom: 8px; }
    .no-stories p { color: var(--text-light); font-size: 0.95rem; max-width: 450px; margin: 0 auto; }

    #page-novel-detail .page-header { justify-content: space-between; }
    .btn-back { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-family: "Cairo", sans-serif; display: flex; align-items: center; gap: 8px; transition: background 0.3s ease; }
    .btn-back:hover { background: rgba(255,255,255,0.25); }
    body.dark-mode .btn-back { background: rgba(200,200,250,0.08); border-color: rgba(200,200,250,0.15); }

    .novel-detail-content { padding: 10px 0; }
    .novel-detail-image { width: 100%; max-height: 380px; object-fit: cover; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 5px 18px var(--shadow); background-color: var(--placeholder-bg); }
    .novel-detail-meta { display: flex; flex-wrap: wrap; gap: 15px 25px; color: var(--text-light); font-size: 0.9rem; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border); transition: border-color 0.3s ease, color 0.3s ease;}
    .novel-detail-meta i { margin-left: 6px; color: var(--primary); }
    .novel-detail-parts { min-height: 100px; }
    .novel-detail-parts p { font-size: 1.1rem; line-height: 1.9; margin-bottom: 20px; color: var(--text); white-space: pre-wrap; }

    .in-content-ad-slot {
        margin: 25px auto;
        padding: 15px;
        border: 1px dashed var(--border);
        background-color: var(--ads-bg);
        border-radius: 8px;
        text-align: center;
        min-height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
     .in-content-ad-slot p {
        color: var(--text-light);
        font-size: 0.85rem;
    }


    .novel-part-navigation { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border); transition: border-color 0.3s ease;}
    .btn-part-nav { background-color: var(--primary); color: var(--text-on-primary); border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-family: "Cairo", sans-serif; font-size: 0.95rem; transition: background-color 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
    .btn-part-nav:hover { background-color: var(--primary-dark); }
    .btn-part-nav:disabled { background-color: var(--text-light); cursor: not-allowed; }
    #part-indicator { font-size: 0.9rem; color: var(--text-light); font-weight: 500; }

    #main-bottom-ad-placeholder {
        text-align:center; padding: 25px; border: 1px dashed var(--border); margin-top:35px; background-color: var(--ads-bg); border-radius: 8px; transition: background-color 0.3s ease, border-color 0.3s ease; min-height: 50px;
    }
    #main-bottom-ad-placeholder p { color: var(--text-light); font-size: 0.9rem;}


    .form-grid { display: grid; grid-template-columns: 1fr; gap: 0 25px; }
     @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 600; color: var(--text-darker); margin-bottom: 8px; font-size: 0.95rem;}
    .form-group label i { margin-left: 6px; color: var(--primary); }

    input[type="text"], input[type="url"], textarea, select { width: 100%; padding: 12px 15px; font-size: 1rem; border: 1px solid var(--border); border-radius: 8px; transition: all 0.3s ease; background: var(--input-bg); color: var(--text); font-family: "Cairo", sans-serif; }
    input[type="text"]:focus, input[type="url"]:focus, textarea[type="focus"], select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); background: var(--card-bg); }
    textarea { min-height: 120px; line-height: 1.7; }

    .upload-preview { margin-top: 10px; border: 2px dashed var(--border); border-radius: 8px; padding: 15px; text-align: center; background-color: var(--input-bg); min-height: 100px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .upload-preview i { font-size: 1.8rem; color: var(--primary); margin-bottom: 8px; }
    .upload-preview p { font-size: 0.85rem; color: var(--text-light); margin:0; }
    #preview-image { max-width: 100%; max-height: 150px; border-radius: 6px; margin-top: 10px; display: none; object-fit: cover; }

    .button-group { display: flex; gap: 15px; justify-content: flex-start; margin-top: 25px; padding-top:20px; border-top: 1px solid var(--border); }
    .btn-primary, .btn-secondary { padding: 12px 25px; font-size: 1rem; border-radius: 8px; border: none; cursor: pointer; font-family: "Cairo", sans-serif; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; }
    .btn-primary { background: var(--primary); color: var(--text-on-primary); }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
    .btn-secondary { background: var(--category-bg); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: color-mix(in srgb, var(--category-bg) 80%, var(--text-light)); transform: translateY(-2px); }
    .btn-primary.pulse { animation: pulseBtn 0.5s ease-in-out; }
    @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .btn-primary:disabled, .btn-secondary:disabled { background-color: var(--text-light); color: var(--card-bg); cursor: not-allowed; opacity: 0.7; }
    .btn-primary i, .btn-secondary i { font-size: 0.9em; }

    .hidden { display: none !important; }
    @media (max-width: 768px) {
        .header-content { padding: 0 10px; }
        .logo h1 { font-size: 1rem; }
        .logo i { font-size: 1.3rem; width: 30px; height: 30px;}
        nav { flex-direction: column; gap: 5px; align-items: flex-start; width: 100%; margin-top: 5px; }
        nav a { padding: 6px 10px; font-size: 0.75rem; width:100%; justify-content: center;}
        .header-right-items { flex-direction: column; align-items: flex-end; gap: 5px;}
        .theme-toggle-btn { width: 30px; height: 30px; font-size: 0.9rem;}
        .page-header h2 { font-size: 1.3rem; }
        .page-header > i { font-size: 1.3rem; width: 40px; height: 40px; }
        .page-content { padding: 15px; }
        .stories-grid { grid-template-columns: 1fr; gap: 15px; }
        .button-group { flex-direction: column; }
        .btn-primary, .btn-secondary { width: 100%; justify-content: center; }
        .form-grid { grid-template-columns: 1fr; }
    }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <header>
    <div class="app-container">
      <div class="header-content">
        <div class="logo"> <i class="fas fa-book-open"></i> <h1>روايات سيف</h1> </div>
        <div class="header-right-items">
            <nav>
              <a href="#" id="nav-list" class="active"> <i class="fas fa-book"></i> مكتبة الروايات </a>
              <a href="#" id="nav-upload"> <i class="fas fa-cloud-upload-alt"></i> رفع رواية جديدة </a>
            </nav>
            <div class="header-actions">
                <button id="theme-toggle-button" class="theme-toggle-btn" aria-label="تبديل الوضع">
                    <i class="fas fa-moon"></i> </button>
            </div>
        </div>
      </div>
    </div>
  </header>

  <div class="app-container">
    <div id="page-list" class="container">
      <div class="page-header"> <i class="fas fa-book-reader"></i> <h2>مكتبة الروايات</h2> </div>
      <div class="page-content">
        <div class="search-container">
          <input type="search" id="search-bar" placeholder="ابحث باسم الرواية أو التصنيف...">
          <i class="fas fa-search search-icon"></i>
        </div>
        <div class="categories">
          <div class="category active" data-category="الكل">الكل</div>
          <div class="category" data-category="مغامرات">مغامرات</div>
          <div class="category" data-category="رومانسية">رومانسية</div>
          <div class="category" data-category="تاريخية">تاريخية</div>
          <div class="category" data-category="خيال علمي">خيال علمي</div>
          <div class="category" data-category="بوليسية">بوليسية</div>
        </div>
        <div id="stories-container" class="stories-grid">
            </div>
      </div>
    </div>

    <div id="page-upload" class="container hidden">
      <div class="page-header"> <i class="fas fa-cloud-upload-alt"></i> <h2>رفع رواية جديدة</h2> </div>
      <div class="page-content">
        <form id="upload-form">
            <div class="form-grid">
              <div>
                <div class="form-group"> <label for="story-title"><i class="fas fa-heading"></i> عنوان الرواية</label> <input type="text" id="story-title" placeholder="مثال: مغامرة في المجهول" required> </div>
                <div class="form-group"> <label for="story-category"><i class="fas fa-tag"></i> التصنيف</label> <select id="story-category" required> <option value="">اختر تصنيفاً</option> <option value="مغامرات">مغامرات</option> <option value="رومانسية">رومانسية</option> <option value="تاريخية">تاريخية</option> <option value="خيال علمي">خيال علمي</option> <option value="بوليسية">بوليسية</option> </select> </div>
                <div class="form-group"> <label for="story-image"><i class="fas fa-image"></i> رابط الصورة (اختياري)</label> <input type="url" id="story-image" placeholder="https://example.com/image.jpg"> <div class="upload-preview"> <i class="fas fa-cloud-upload-alt"></i> <p>ستظهر صورة الرواية هنا إذا تم توفير رابط</p> <img id="preview-image" src="" alt="معاينة الصورة"> </div> </div>
              </div>
              <div>
                <div class="form-group"> <label for="story-part1"><i class="fas fa-align-left"></i> الجزء الأول</label> <textarea id="story-part1" placeholder="اكتب الجزء الأول من الرواية..." required></textarea> </div>
                <div class="form-group"> <label for="story-part2"><i class="fas fa-align-left"></i> الجزء الثاني (اختياري)</label> <textarea id="story-part2" placeholder="اكتب الجزء الثاني..."></textarea> </div>
                <div class="form-group"> <label for="story-part3"><i class="fas fa-align-left"></i> الجزء الثالث (اختياري)</label> <textarea id="story-part3" placeholder="اكتب الجزء الثالث..."></textarea> </div>
              </div>
            </div>
            <div class="button-group"> <button type="submit" id="upload-button" class="btn-primary"> <i class="fas fa-paper-plane"></i> نشر الرواية </button> <button type="button" id="cancel-upload-button" class="btn-secondary"> <i class="fas fa-times"></i> إلغاء </button> </div>
        </form>
      </div>
    </div>

    <div id="page-novel-detail" class="container hidden">
        <div class="page-header">
            <button id="back-to-list-button" class="btn-back">
                <i class="fas fa-arrow-right"></i> الرجوع للقائمة
            </button>
            <h2 id="detail-novel-title-header"></h2>
        </div>
        <div class="page-content">
            <div class="novel-detail-content">
                <img id="detail-novel-image" src="" alt="صورة الرواية" class="novel-detail-image">
                <div class="novel-detail-meta">
                    <span id="detail-novel-category"><i class="fas fa-tag"></i></span>
                    <span id="detail-novel-date"><i class="far fa-calendar"></i></span>
                </div>
                <div id="detail-novel-parts" class="novel-detail-parts">
                    </div>
                <div class="novel-part-navigation">
                    <button id="prev-part-button" class="btn-part-nav hidden"><i class="fas fa-arrow-right"></i> الجزء السابق</button>
                    <span id="part-indicator"></span>
                    <button id="next-part-button" class="btn-part-nav hidden">الجزء التالي <i class="fas fa-arrow-left"></i></button>
                </div>
                <div id="main-bottom-ad-placeholder" class="ads-placeholder">
                     <p>Advertisement</p>
                </div>
            </div>
        </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref, set, get, push, onValue, query, orderByChild, remove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
    authDomain: "story-97cf7.firebaseapp.com",
    databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
    projectId: "story-97cf7",
    storageBucket: "story-97cf7.appspot.com",
    messagingSenderId: "742801388214", // <-- تم تصحيح الخطأ الإملائي هنا
    appId: "1:742801388214:web:32a305a8057b0582c5ec17",
    measurementId: "G-9DPPWX7CF0"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  window.fbDb = database;
  window.fbRef = ref;
  window.fbSet = set;
  window.fbGet = get;
  window.fbPush = push;
  window.fbOnValue = onValue;
  window.fbQuery = query;
  window.fbOrderByChild = orderByChild;
  window.fbRemove = remove;

  if (window.onFirebaseReady) {
    window.onFirebaseReady();
  }
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const navList = document.getElementById('nav-list');
    const navUpload = document.getElementById('nav-upload');
    const pageList = document.getElementById('page-list');
    const pageUpload = document.getElementById('page-upload');
    const pageNovelDetail = document.getElementById('page-novel-detail');

    const storiesContainer = document.getElementById('stories-container');
    const uploadForm = document.getElementById('upload-form');
    const uploadButton = document.getElementById('upload-button');
    const cancelUploadButton = document.getElementById('cancel-upload-button');
    const storyImageInput = document.getElementById('story-image');
    const previewImage = document.getElementById('preview-image');
    const searchBar = document.getElementById('search-bar');
    const categoriesContainer = document.querySelector('.categories');

    const detailNovelTitleHeader = document.getElementById('detail-novel-title-header');
    const detailNovelImage = document.getElementById('detail-novel-image');
    const detailNovelCategory = document.getElementById('detail-novel-category');
    const detailNovelDate = document.getElementById('detail-novel-date');
    const detailNovelPartsContainer = document.getElementById('detail-novel-parts');
    const backToListButton = document.getElementById('back-to-list-button');

    const prevPartButton = document.getElementById('prev-part-button');
    const nextPartButton = document.getElementById('next-part-button');
    const partIndicator = document.getElementById('part-indicator');
    const mainBottomAdPlaceholder = document.getElementById('main-bottom-ad-placeholder');

    const themeToggleButton = document.getElementById('theme-toggle-button');
    const themeIcon = themeToggleButton.querySelector('i');

    let currentOpenNovel = null;
    let currentNovelPartIndex = 0;
    let allStoriesCache = [];
    let firebaseInitialized = false;
    let adInstanceCounter = 0;

    // ------------ START: Logic for "Click Anywhere" Ad (Pop-up/Pop-under) ------------
    const AD_URL_CLICK_ANYWHERE = "https://www.profitableratecpm.com/d5castnfa9?key=59c06a9ab9c76401dc8a32fdd5d44695";
    const AD_CLICK_INTERVAL_MS = 5000; // تم التعديل إلى 5 ثواني
    let adClickArmed = false;
    let adClickIntervalTimerId = null;
    let globalAdClickListenerAdded = false;

    function setupPeriodicAdClick() {
        console.log("إعداد آلية إعلان النقر الدوري. مسلح حالياً: " + adClickArmed);

        if (adClickIntervalTimerId) {
            clearInterval(adClickIntervalTimerId); 
        }

        // كل 5 ثواني، يتم "تسليح" الإعلان. النقرة التالية المؤهلة ستفعله.
        adClickIntervalTimerId = setInterval(() => {
            adClickArmed = true;
            console.log("تم تسليح نقرة الإعلان بواسطة المؤقت. النقرة التالية المؤهلة ستفعل الإعلان.");
        }, AD_CLICK_INTERVAL_MS);

        if (!globalAdClickListenerAdded) {
            document.documentElement.addEventListener('click', function(event) {
                // قائمة العناصر التي إذا تم النقر عليها، *لن* يتم تفعيل الإعلان.
                // هذا لمنع الإعلانات المزعجة عند استخدام واجهة المستخدم الأساسية.
                // يمكنك تعديل هذه القائمة إذا أردت سلوكًا مختلفًا.
                const criticalSelectors = '.page-header, .btn-part-nav, .theme-toggle-btn, nav a, .category, #upload-form button, .btn-delete-story, .btn-back, #search-bar, .form-group input, .form-group select, .form-group textarea, .story-card-visual';
                
                if (event.target.closest(criticalSelectors)) {
                    // console.log("تم النقر على عنصر واجهة مستخدم هام، تم تجاهل تفعيل الإعلان لهذه المرة.");
                    return;
                }

                if (adClickArmed) {
                    console.log("تم اكتشاف نقرة والإعلان مسلح. محاولة فتح رابط الإعلان:", AD_URL_CLICK_ANYWHERE);
                    
                    // محاولة فتح الإعلان في نافذة جديدة.
                    // **ملاحظة هامة:** معظم المتصفحات ستحظر هذا الإجراء إذا لم يكن نتيجة مباشرة لنقرة المستخدم.
                    let newWindow = window.open(AD_URL_CLICK_ANYWHERE, '_blank');
                    
                    if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                        console.warn("فشل فتح النافذة الجديدة. غالباً بسبب حاصر النوافذ المنبثقة في المتصفح.");
                        // يمكنك هنا إعلام المستخدم بأن النافذة تم حظرها، إذا أردت.
                    } else {
                        console.log("تم فتح نافذة الإعلان بنجاح (أو لم يتم حظرها).");
                    }
                    
                    adClickArmed = false; // إلغاء تسليح الإعلان بعد محاولة الفتح.
                    console.log("تم إلغاء تسليح نقرة الإعلان. انتظار المؤقت التالي.");
                }
            }, true); 
            globalAdClickListenerAdded = true;
            console.log("تمت إضافة مستمع النقر العام لآلية إعلانات النقر الدوري.");
        }
    }
    // ------------ END: Logic for "Click Anywhere" Ad ------------


    function mainAppInit() {
        if (!window.fbDb) {
            window.onFirebaseReady = initializeFirebaseAndData; // تأكد من أن initializeFirebaseAndData هي التي تستدعي باقي التهيئة
            return;
        }
        initializeFirebaseAndData(); // إذا كان Firebase جاهزًا بالفعل

        // بقية تهيئة واجهة المستخدم
        navList.onclick = (e) => { e.preventDefault(); showListPage(); };
        navUpload.onclick = (e) => { e.preventDefault(); showUploadPage(); };
        if(cancelUploadButton) {
           cancelUploadButton.onclick = (e) => { e.preventDefault(); showListPage(); };
        }
        uploadForm.addEventListener('submit', handleUploadSubmit);
        storyImageInput.addEventListener('input', handleImagePreview);
        searchBar.addEventListener('input', filterAndRenderStories);
        categoriesContainer.querySelectorAll('.category').forEach(cat => {
            cat.addEventListener('click', function() {
                categoriesContainer.querySelector('.category.active').classList.remove('active');
                this.classList.add('active');
                filterAndRenderStories();
            });
        });
        backToListButton.addEventListener('click', () => {
            pageNovelDetail.classList.add('hidden');
            currentOpenNovel = null;
            showListPage();
        });

        nextPartButton.addEventListener('click', handleNextPart);
        prevPartButton.addEventListener('click', handlePrevPart);
        themeToggleButton.addEventListener('click', toggleTheme);
        setupInitialTheme();

        // استدعاء دالة إعداد إعلانات النقر الدوري مرة واحدة عند بدء التطبيق
        setupPeriodicAdClick(); 
        showListPage(); // عرض الصفحة الافتراضية
    }

    window.onFirebaseReady = () => { 
        console.log("Firebase ready callback triggered.");
        if (!firebaseInitialized) { 
            // استدعاء mainAppInit هنا بدلاً من initializeFirebaseAndData مباشرة
            // mainAppInit ستقوم باستدعاء initializeFirebaseAndData
            mainAppInit(); 
        } 
    };

    // محاولة التهيئة إذا كان Firebase جاهزًا بشكل متزامن
    if (window.fbDb && !firebaseInitialized) {
        console.log("Firebase was ready synchronously.");
        mainAppInit();
    }


    function initializeFirebaseAndData() {
        if (firebaseInitialized || !window.fbDb || !window.fbOnValue || !window.fbRef || !window.fbQuery || !window.fbOrderByChild) {
            if (firebaseInitialized) console.log("Firebase data already initialized.");
            else console.log("Firebase SDK functions not fully available yet for data initialization.");
            return;
        }
        firebaseInitialized = true; // ضع هذا هنا للتأكد أنه يتم مرة واحدة فقط
        console.log("Initializing Firebase data listener...");

        const db = window.fbDb;
        const storiesQuery = window.fbQuery(window.fbRef(db, 'stories'), window.fbOrderByChild('timestamp'));
        window.fbOnValue(storiesQuery, (snapshot) => {
            allStoriesCache = [];
            if (snapshot.exists()) {
                const storiesData = snapshot.val();
                for (const key in storiesData) {
                    allStoriesCache.push({ id: key, ...storiesData[key] });
                }
                allStoriesCache.reverse();
                console.log("Stories loaded/updated from Firebase:", allStoriesCache.length);
            } else {
                console.log("No stories found in Firebase.");
            }
            if (!pageList.classList.contains('hidden')) { // تحديث القائمة فقط إذا كانت معروضة
                filterAndRenderStories();
            }
        }, (error) => {
            console.error("Firebase read failed: ", error);
            storiesContainer.innerHTML = `<div class="no-stories"><i class="fas fa-exclamation-triangle"></i><h3> خطأ في التحميل</h3><p>لم نتمكن من الاتصال بقاعدة البيانات (${error.message}).</p></div>`;
        });
    }

    function loadProfitableratecpmAd(targetContainer, instanceNumber) {
        if (!targetContainer) {
            // console.warn(`[AdInstance ${instanceNumber}] Target container for Profitableratecpm ad not provided.`);
            return;
        }
        targetContainer.innerHTML = ''; // مسح المحتوى القديم

        const adScriptSrc = "//pl26515491.profitableratecpm.com/3e36ee9beffd0a2aac4d4278fdf8e340/invoke.js";
        const adInvokeContainerId = "container-3e36ee9beffd0a2aac4d4278fdf8e340"; // هذا ID يجب أن يكون فريدًا للصفحة إذا كان السكريبت يتوقعه كذلك

        // بعض شبكات الإعلانات تحتاج إلى ID فريد لكل مرة يتم فيها تحميل السكريبت أو لكل حاوية.
        // إذا كان السكريبت يعيد استخدام نفس ID الحاوية (adInvokeContainerId)، قد تحتاج إلى التأكد من أن هذا ID غير مستخدم في مكان آخر بشكل متزامن.
        // في حالتنا، يتم استدعاء هذه الدالة لحاويات مختلفة (in-content-ad-slot-X و main-bottom-ad-placeholder)
        // أو يتم مسح الحاوية وإعادة إنشائها.
        
        const adContentDiv = document.createElement('div');
        // قد تحتاج شبكة الإعلانات إلى هذا الـ ID للحاوية التي ستضع فيها الإعلان
        adContentDiv.id = `${adInvokeContainerId}_${instanceNumber}`; // جعل الـ ID فريدًا لكل مثيل
        targetContainer.appendChild(adContentDiv);

        const script = document.createElement('script');
        script.async = true;
        script.setAttribute('data-cfasync', 'false');
        // إضافة متغير عشوائي لمنع التخزين المؤقت القوي للسكريبت إذا كان ذلك يسبب مشاكل
        script.src = `${adScriptSrc}?v=${new Date().getTime()}_${instanceNumber}`; 
        
        script.onload = () => {
            // console.log(`[AdInstance ${instanceNumber}] Profitableratecpm ad script loaded from: ${script.src}`);
            // يمكنك إضافة تأخير صغير للتحقق مما إذا تم عرض الإعلان
            setTimeout(() => {
                let adRendered = false;
                // تحقق مما إذا كانت الحاوية الأصلية (targetContainer) أو الحاوية الداخلية (adContentDiv) تحتوي على شيء
                if (targetContainer && (targetContainer.innerHTML.trim() !== '' && targetContainer.children.length > 1 || (targetContainer.children.length === 1 && targetContainer.firstChild !== adContentDiv && targetContainer.firstChild !== script) || (adContentDiv && adContentDiv.innerHTML.trim() !== ''))) {
                    adRendered = true;
                }
                if (!adRendered) {
                    // console.warn(`[AdInstance ${instanceNumber}] Ad script loaded, but no ad content detected in target or adContentDiv.`);
                } else {
                     // console.log(`[AdInstance ${instanceNumber}] Ad content seems to be rendered.`);
                }
            }, 1000); // زيادة التأخير قليلاً لإعطاء فرصة للإعلان للتحميل
        };
        script.onerror = () => {
            console.error(`[AdInstance ${instanceNumber}] Failed to load Profitableratecpm ad script from: ${script.src}`);
            if (targetContainer) { // تأكد أن الحاوية لا تزال موجودة
                 targetContainer.innerHTML = "<p>خطأ في تحميل الإعلان.</p>";
            }
        };
        
        // إضافة السكريبت إلى الحاوية الأصلية أو إلى نهاية الـ body
        // بعض السكريبتات تعمل بشكل أفضل عند إضافتها إلى body
        document.body.appendChild(script); // أو targetContainer.appendChild(script);
                                        // جرب document.body.appendChild(script) إذا لم يعمل بشكل جيد داخل الحاوية مباشرة
    }


    async function handleDeleteStory(storyId, storyTitle) {
        if (!window.fbDb || !window.fbRef || !window.fbRemove) {
             alert("خطأ في الاتصال بقاعدة البيانات. لا يمكن الحذف.");
             return;
        }
        const confirmCode = prompt(`لحذف رواية "${storyTitle}"، يرجى إدخال رمز الحذف:`);
        if (confirmCode === null) return;

        if (confirmCode === 'saif123') {
            const confirmed = confirm(`هل أنت متأكد من أنك تريد حذف رواية "${storyTitle}" نهائياً؟ لا يمكن التراجع عن هذا الإجراء.`);
            if (confirmed) {
                try {
                    const db = window.fbDb;
                    const storyRef = window.fbRef(db, 'stories/' + storyId);
                    await window.fbRemove(storyRef);
                    // لا حاجة لتحديث allStoriesCache يدويًا هنا، onValue سيقوم بذلك
                } catch (error) {
                    console.error("Error deleting story:", error);
                    alert(`حدث خطأ أثناء حذف الرواية: ${error.message}`);
                }
            }
        } else {
            alert('رمز الحذف غير صحيح. لم يتم حذف الرواية.');
        }
    }

    function renderStories(storiesToRender, isSearchResult = false) {
        storiesContainer.innerHTML = '';
        if (storiesToRender.length === 0) {
            const messageType = isSearchResult ? "noResults" : "noStoriesYet";
            storiesContainer.innerHTML = `<div class="no-stories fade-in"><i class="fas ${messageType === 'noResults' ? 'fa-search' : 'fa-book-open'}"></i><h3>${messageType === 'noResults' ? 'لا توجد نتائج تطابق بحثك' : 'لا توجد روايات بعد'}</h3><p>${messageType === 'noResults' ? 'حاول بكلمات أخرى أو اختر تصنيفاً مختلفاً.' : 'ابدأ بإضافة روايتك الأولى من خلال زر "رفع رواية جديدة".'}</p></div>`;
            return;
        }
        storiesToRender.forEach((story, index) => {
            const div = document.createElement('div');
            div.classList.add('story-card-visual', 'fade-in');
            div.style.animationDelay = `${index * 0.05}s`;
            div.dataset.storyId = story.id;
            const defaultImagePlaceholder = `<div class="no-image-placeholder"><i class="fas fa-book-open"></i><span>${story.title || 'رواية'}</span></div>`;

            div.innerHTML = `
                <button class="btn-delete-story" title="حذف الرواية"><i class="fas fa-trash-alt"></i></button>
                ${story.image ? `<img class="story-image-visual" src="${story.image}" alt="${story.title || 'صورة الرواية'}">` : defaultImagePlaceholder}
                <div class="story-title-visual">${story.title || 'عنوان غير متوفر'}</div>`;

            if (story.image) {
                const imgElement = div.querySelector('.story-image-visual');
                imgElement.onerror = function() { this.outerHTML = defaultImagePlaceholder; };
            }

            div.addEventListener('click', (event) => {
                if (event.target.closest('.btn-delete-story')) return; // لا تفتح التفاصيل عند الضغط على زر الحذف
                const clickedStory = allStoriesCache.find(s => s.id === story.id);
                if (clickedStory) showNovelDetailPage(clickedStory);
            });

            div.querySelector('.btn-delete-story').addEventListener('click', (event) => {
                event.stopPropagation(); // منع الفقاعات لعدم تفعيل نقرة البطاقة
                handleDeleteStory(story.id, story.title);
            });
            storiesContainer.appendChild(div);
        });
    }

    function displayCurrentNovelPart() {
        detailNovelPartsContainer.innerHTML = ''; // مسح الأجزاء والإعلانات القديمة
        adInstanceCounter = 0; // إعادة تعيين عداد مثيلات الإعلانات لكل جزء

        if (!currentOpenNovel || !currentOpenNovel.parts || currentOpenNovel.parts.length === 0) {
            detailNovelPartsContainer.innerHTML = "<p>لا توجد أجزاء لهذه الرواية.</p>";
            prevPartButton.classList.add('hidden');
            nextPartButton.classList.add('hidden');
            partIndicator.textContent = '';
            if (mainBottomAdPlaceholder) mainBottomAdPlaceholder.style.display = 'block'; // عرض الإعلان السفلي إذا لم يكن هناك محتوى
            return;
        }

        const parts = Array.isArray(currentOpenNovel.parts) ? currentOpenNovel.parts : [currentOpenNovel.parts];
        let currentPartText = (parts.length > 0 && parts[currentNovelPartIndex] && typeof parts[currentNovelPartIndex] === 'string')
                                ? parts[currentNovelPartIndex].trim() : "";

        if (!currentPartText) {
            detailNovelPartsContainer.innerHTML = "<p>الجزء المحدد غير متوفر أو فارغ.</p>";
        } else {
            const idealSplitLength = 500; // طول القطعة التقريبي بين الإعلانات
            let remainingText = currentPartText;
            let hasInContentAds = false; // لتتبع ما إذا تم وضع إعلانات داخل المحتوى

            while (remainingText.length > 0) {
                let chunk;
                let actualSplitLength;

                if (remainingText.length <= idealSplitLength) {
                    actualSplitLength = remainingText.length;
                } else {
                    // محاولة تقسيم النص عند مسافة أو سطر جديد بالقرب من الطول المثالي
                    actualSplitLength = idealSplitLength;
                    let splitAt = -1;
                    // البحث للخلف عن فاصل
                    for (let i = idealSplitLength; i > idealSplitLength / 2 && i > 0; i--) {
                        if (remainingText[i] === ' ' || remainingText[i] === '\n') {
                            splitAt = i;
                            break;
                        }
                    }
                    // إذا لم يتم العثور على فاصل للخلف، ابحث للأمام (بحد معين)
                    if (splitAt === -1) {
                        for (let i = idealSplitLength + 1; i < remainingText.length && i < idealSplitLength * 1.5; i++) {
                            if (remainingText[i] === ' ' || remainingText[i] === '\n') {
                                splitAt = i;
                                break;
                            }
                        }
                    }
                    // تحديد طول القطعة الفعلي
                    actualSplitLength = (splitAt !== -1) ? splitAt + 1 : idealSplitLength; // +1 لتضمين الفاصل
                    if (actualSplitLength > remainingText.length) actualSplitLength = remainingText.length;
                }

                chunk = remainingText.substring(0, actualSplitLength);
                remainingText = remainingText.substring(actualSplitLength).trimStart(); // إزالة المسافات البادئة من النص المتبقي

                const p = document.createElement('p');
                p.textContent = chunk;
                p.classList.add('fade-in');
                detailNovelPartsContainer.appendChild(p);

                // إضافة إعلان إذا كان هناك نص متبقي وكانت القطعة الحالية ذات طول معقول
                if (remainingText.length > 0 && chunk.length > 100) { // لا تضع إعلانًا بعد قطعة صغيرة جدًا
                    hasInContentAds = true;
                    adInstanceCounter++;
                    const adSlotDiv = document.createElement('div');
                    adSlotDiv.classList.add('in-content-ad-slot');
                    // استخدام ID فريد لكل مكان إعلاني
                    adSlotDiv.id = `in-content-ad-slot-${currentNovelPartIndex}-${adInstanceCounter}`;
                    detailNovelPartsContainer.appendChild(adSlotDiv);
                    
                    // استدعاء دالة تحميل الإعلان البانر
                    loadProfitableratecpmAd(adSlotDiv, adInstanceCounter);
                }
            }

            // التحكم في ظهور الإعلان السفلي الرئيسي
            if (mainBottomAdPlaceholder) {
                if (hasInContentAds) {
                    mainBottomAdPlaceholder.style.display = 'none'; // إخفاء الإعلان السفلي إذا كانت هناك إعلانات في المحتوى
                } else {
                    mainBottomAdPlaceholder.style.display = 'block'; // عرضه إذا لم تكن هناك إعلانات في المحتوى
                    loadProfitableratecpmAd(mainBottomAdPlaceholder, 0); // 0 كمثال لـ instanceNumber
                }
            }
        }

        partIndicator.textContent = `الجزء ${currentNovelPartIndex + 1} من ${parts.length}`;
        prevPartButton.classList.toggle('hidden', currentNovelPartIndex <= 0);
        nextPartButton.classList.toggle('hidden', currentNovelPartIndex >= parts.length - 1);

        const navContainer = prevPartButton.parentElement;
        if (parts.length <= 1) {
            navContainer.classList.add('hidden');
        } else {
            navContainer.classList.remove('hidden');
        }
    }


    function handleNextPart() {
        const parts = Array.isArray(currentOpenNovel.parts) ? currentOpenNovel.parts : [currentOpenNovel.parts];
        if (currentOpenNovel && currentNovelPartIndex < parts.length - 1) {
            currentNovelPartIndex++;
            displayCurrentNovelPart();
        }
    }

    function handlePrevPart() {
        if (currentOpenNovel && currentNovelPartIndex > 0) {
            currentNovelPartIndex--;
            displayCurrentNovelPart();
        }
    }

    function showNovelDetailPage(story) {
        pageList.classList.add('hidden');
        pageUpload.classList.add('hidden');

        currentOpenNovel = story;
        currentNovelPartIndex = 0; // ابدأ دائمًا من الجزء الأول عند فتح رواية جديدة

        detailNovelTitleHeader.textContent = story.title;
        if (story.image) {
            detailNovelImage.src = story.image;
            detailNovelImage.alt = story.title;
            detailNovelImage.style.display = 'block';
            detailNovelImage.onerror = function() { this.style.display = 'none'; }; // إخفاء الصورة إذا فشل التحميل
        } else {
            detailNovelImage.src = ""; // مسح المصدر القديم
            detailNovelImage.style.display = 'none';
        }
        detailNovelCategory.innerHTML = `<i class="fas fa-tag"></i> ${story.category || 'بدون تصنيف'}`;

        // استخدام timestamp إذا كان موجودًا، وإلا تاريخ الرفع (date)
        const displayDate = story.timestamp ? new Date(parseInt(story.timestamp)).toLocaleDateString('ar-EG-u-nu-latn', { year: 'numeric', month: 'long', day: 'numeric' }) : (story.date || 'غير معروف');
        detailNovelDate.innerHTML = `<i class="far fa-calendar"></i> ${displayDate}`;

        displayCurrentNovelPart(); // عرض الجزء الأول والإعلانات المرتبطة به

        pageNovelDetail.classList.remove('hidden');
        pageNovelDetail.classList.add('fade-in');
        window.scrollTo(0, 0); // الانتقال إلى أعلى الصفحة
    }


    function filterAndRenderStories() {
        const searchTerm = searchBar.value.toLowerCase().trim();
        const activeCategoryElement = categoriesContainer.querySelector('.category.active');
        const activeCategory = activeCategoryElement ? activeCategoryElement.dataset.category : "الكل";

        let filteredStories = [...allStoriesCache]; // العمل على نسخة من الكاش

        if (activeCategory !== "الكل") {
            filteredStories = filteredStories.filter(story => story.category === activeCategory);
        }
        if (searchTerm !== "") {
            filteredStories = filteredStories.filter(story =>
                (story.title && story.title.toLowerCase().includes(searchTerm)) ||
                (story.category && story.category.toLowerCase().includes(searchTerm)) // البحث في التصنيف أيضًا
            );
        }
        renderStories(filteredStories, searchTerm !== "" || activeCategory !== "الكل");
    }

    function showListPage() {
        pageList.classList.remove('hidden');
        pageUpload.classList.add('hidden');
        pageNovelDetail.classList.add('hidden');
        pageList.classList.add('fade-in'); // تأثير ظهور تدريجي
        navList.classList.add('active');
        if (navUpload) navUpload.classList.remove('active');
        filterAndRenderStories(); // عرض القصص عند العودة إلى القائمة
    }

    function showUploadPage() {
        pageUpload.classList.remove('hidden');
        pageList.classList.add('hidden');
        pageNovelDetail.classList.add('hidden');
        pageUpload.classList.add('fade-in');
        if (navUpload) navUpload.classList.add('active');
        navList.classList.remove('active');

        uploadForm.reset(); // مسح الحقول
        previewImage.style.display = 'none';
        previewImage.src = '';
        // إظهار الأيقونة والنص في معاينة الصورة
        const previewContainer = storyImageInput.nextElementSibling;
        const previewIcon = previewContainer.querySelector('i');
        const previewText = previewContainer.querySelector('p');
        if (previewIcon) previewIcon.style.display = 'block';
        if (previewText) previewText.style.display = 'block';
        window.scrollTo(0,0);
    }

    function handleImagePreview() {
        const previewContainer = this.nextElementSibling; // حاوية المعاينة
        const icon = previewContainer.querySelector('i');
        const text = previewContainer.querySelector('p');

        if (this.value && this.checkValidity()) { // تأكد أن الرابط صالح (ولو بشكل مبدئي)
            previewImage.src = this.value;
            previewImage.style.display = 'block';
            if(icon) icon.style.display = 'none'; // إخفاء الأيقونة
            if(text) text.style.display = 'none'; // إخفاء النص
        } else {
            previewImage.style.display = 'none';
            previewImage.src = '';
            if(icon) icon.style.display = 'block'; // إظهار الأيقونة
            if (text) text.style.display = 'block'; // إظهار النص
        }
        previewImage.onerror = function() { // في حالة فشل تحميل الصورة من الرابط
            this.style.display = 'none';
            this.src = '';
            if(icon) icon.style.display = 'block';
            if (text) text.style.display = 'block';
            storyImageInput.value = ""; // مسح الرابط غير الصالح
        };
    }

    async function handleUploadSubmit(event) {
        event.preventDefault();
        if (!window.fbDb || !window.fbPush || !window.fbSet || !window.fbRef) {
            alert("خطأ في الاتصال بقاعدة البيانات. الرجاء المحاولة مرة أخرى.");
            return;
        }

        const title = document.getElementById('story-title').value.trim();
        const image = document.getElementById('story-image').value.trim();
        const category = document.getElementById('story-category').value;
        const parts = [
            document.getElementById('story-part1').value.trim(),
            document.getElementById('story-part2').value.trim(),
            document.getElementById('story-part3').value.trim()
        ].filter(part => part); // إزالة الأجزاء الفارغة

        if (!title || parts.length === 0 || !parts[0] || !category) { // تأكد أن الجزء الأول على الأقل موجود
            alert('يرجى ملء عنوان الرواية، التصنيف، والجزء الأول على الأقل.');
            return;
        }

        const today = new Date();
        const dateString = today.toLocaleDateString('ar-EG-u-nu-latn', { year: 'numeric', month: 'long', day: 'numeric' });
        const newStoryData = { 
            title, 
            category, 
            image: image || "", // قيمة افتراضية إذا كان الرابط فارغًا
            parts, 
            date: dateString, 
            timestamp: Date.now().toString() // تخزين الوقت الحالي كـ timestamp للفرز
        };

        uploadButton.disabled = true;
        uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري النشر...';

        try {
            const db = window.fbDb;
            const newStoryRef = window.fbPush(window.fbRef(db, 'stories'));
            // إضافة id القصة إلى بياناتها لتسهيل الوصول إليه لاحقًا إذا لزم الأمر
            await window.fbSet(newStoryRef, { ...newStoryData, id: newStoryRef.key });

            uploadButton.innerHTML = '<i class="fas fa-check"></i> تم النشر بنجاح!';
            uploadButton.classList.add('pulse');
            uploadButton.style.background = 'var(--success)';

            setTimeout(() => {
                showListPage(); // العودة إلى قائمة الروايات
                // إعادة الزر إلى حالته الطبيعية ومسح النموذج
                uploadButton.innerHTML = '<i class="fas fa-paper-plane"></i> نشر الرواية';
                uploadButton.classList.remove('pulse');
                uploadButton.style.background = '';
                uploadButton.disabled = false;
                uploadForm.reset();
                handleImagePreview.call(storyImageInput); // إعادة تعيين معاينة الصورة
            }, 1500);
        } catch (error) {
            console.error("Error uploading story:", error);
            alert("حدث خطأ أثناء نشر الرواية: " + error.message);
            uploadButton.innerHTML = '<i class="fas fa-paper-plane"></i> نشر الرواية';
            uploadButton.style.background = '';
            uploadButton.disabled = false;
        }
    }

    function setTheme(theme) {
       if (theme === 'dark') {
           document.body.classList.add('dark-mode');
           themeIcon.classList.remove('fa-moon');
           themeIcon.classList.add('fa-sun');
           localStorage.setItem('theme', 'dark');
       } else {
           document.body.classList.remove('dark-mode');
           themeIcon.classList.remove('fa-sun');
           themeIcon.classList.add('fa-moon');
           localStorage.setItem('theme', 'light');
       }
    }

    function toggleTheme() {
       setTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark');
       localStorage.setItem('theme_user_set', 'true'); // تذكر أن المستخدم اختار السمة يدويًا
    }

    function setupInitialTheme() {
        const savedTheme = localStorage.getItem('theme');
        const userManuallySetTheme = localStorage.getItem('theme_user_set') === 'true';

        if (savedTheme) { // إذا كان هناك سمة محفوظة، استخدمها
           setTheme(savedTheme);
        } else if (!userManuallySetTheme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
           // إذا لم يختر المستخدم سمة يدويًا، وكان المتصفح يفضل السمة الداكنة، استخدمها
           setTheme('dark');
        } else {
           // وإلا، استخدم السمة الفاتحة كافتراضي
           setTheme('light');
        }
        
        // الاستماع لتغييرات تفضيل السمة في نظام التشغيل/المتصفح
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (localStorage.getItem('theme_user_set') !== 'true') { // غير السمة فقط إذا لم يختر المستخدم واحدة يدويًا
                setTheme(event.matches ? "dark" : "light");
            }
        });
    }

    // بداية تشغيل التطبيق
    // تأكد من أن Firebase جاهز قبل بدء التطبيق الرئيسي
    if (window.fbDb) { // إذا كان Firebase قد تم تهيئته بالفعل
      mainAppInit();
    } else { // وإلا، انتظر حدث onFirebaseReady
      window.onFirebaseReady = mainAppInit;
    }

    // New JavaScript to handle opening the URL on button click
    document.addEventListener('click', function(event) {
        // Check if the clicked element is a button or a descendant of a button
        if (event.target.tagName === 'BUTTON' || event.target.closest('button')) {
            // Open the URL in a new tab
            window.open('https://www.profitableratecpm.com/d5castnfa9?key=59c06a9ab9c76401dc8a32fdd5d44695', '_blank');
        }
    });

});
</script>

</body>
</html>
