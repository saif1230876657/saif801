<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>مكالمة فيديو جماعية</title>
  <style>
    body { background: #111; color: white; font-family: sans-serif; text-align: center; }
    input, button { padding: 10px; margin: 10px; font-size: 18px; }
    video { width: 300px; height: 225px; background: black; margin: 10px; border-radius: 10px; }
    #videos { display: flex; flex-wrap: wrap; justify-content: center; }
  </style>
</head>
<body>
  <h1>مكالمة فيديو برمز سري</h1>
  <input type="text" id="roomId" placeholder="اكتب رمز الغرفة مثلاً saif123" />
  <button onclick="startCall()">انضم للمكالمة</button>
  <div id="videos"></div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let localStream;
    let peers = {};

    async function startCall() {
      const room = document.getElementById('roomId').value.trim();
      if (!room) return alert("اكتب رمز الغرفة");

      const myId = room + "-" + Math.floor(Math.random() * 100000);
      const peer = new Peer(myId, {
        host: 'peerjs.com',
        port: 443,
        secure: true
      });

      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      addVideo(myId, localStream, true);

      peer.on('open', () => {
        console.log("بدأ الاتصال كـ", myId);

        fetchPeersInRoom(room).then(ids => {
          ids.forEach(id => {
            if (id !== myId) {
              const call = peer.call(id, localStream);
              call.on('stream', stream => addVideo(id, stream));
              peers[id] = call;
            }
          });
        });
      });

      peer.on('call', call => {
        call.answer(localStream);
        call.on('stream', stream => addVideo(call.peer, stream));
        peers[call.peer] = call;
      });
    }

    function addVideo(id, stream, muted = false) {
      if (document.getElementById(id)) return;
      const video = document.createElement('video');
      video.id = id;
      video.srcObject = stream;
      video.autoplay = true;
      video.playsInline = true;
      video.muted = muted;
      document.getElementById('videos').appendChild(video);
    }

    // خدمة بسيطة تجيب كل الـ Peer IDs في الغرفة
    async function fetchPeersInRoom(room) {
      try {
        const res = await fetch(`https://peerjs.com/peers`);
        const all = await res.json();
        return all.filter(id => id.startsWith(room + "-"));
      } catch (e) {
        return [];
      }
    }
  </script>
</body>
</html>
